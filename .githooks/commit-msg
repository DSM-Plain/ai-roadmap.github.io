#!/bin/bash

# ========================================
# Git Commit Message Hook
# 브랜치 네이밍 규칙 및 커밋 메시지 prefix 검증
# ========================================

# 색상 정의 (터미널 출력용)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 커밋 메시지 파일 (Git이 자동으로 전달)
COMMIT_MSG_FILE=$1

# 현재 브랜치 이름
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

# 허용된 브랜치 prefix 목록
ALLOWED_PREFIXES=("docs" "edit" "delete" "feat" "fix" "remove")

# ========================================
# 1. main/master 브랜치 예외 처리
# ========================================
if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" ]]; then
    echo -e "${GREEN}✓ main 브랜치: 검증을 건너뜁니다.${NC}"
    exit 0
fi

# ========================================
# 2. 브랜치 네이밍 규칙 검증
# ========================================
# 형식: {prefix}/{description}
# - prefix: docs, edit, delete, feat, fix, remove
# - description: 소문자, 숫자, 하이픈(-)만 허용
BRANCH_PATTERN="^(docs|edit|delete|feat|fix|remove)/[a-z0-9]+(-[a-z0-9]+)*$"

if ! [[ "$CURRENT_BRANCH" =~ $BRANCH_PATTERN ]]; then
    echo -e "${RED}========================================"
    echo "[브랜치 네이밍 규칙 오류]"
    echo "========================================"
    echo ""
    echo "현재 브랜치: $CURRENT_BRANCH"
    echo ""
    echo "허용되지 않는 브랜치 이름입니다."
    echo ""
    echo "올바른 형식:"
    echo "  {prefix}/{description}"
    echo ""
    echo "허용된 prefix:"
    echo "  - docs/    : 문서 생성"
    echo "  - edit/    : 문서 수정"
    echo "  - delete/  : 문서 삭제"
    echo "  - feat/    : 로드맵 기능 추가"
    echo "  - fix/     : 기능 수정 (hotfix 포함)"
    echo "  - remove/  : 기능 삭제"
    echo ""
    echo "규칙:"
    echo "  - description은 소문자와 숫자만 사용"
    echo "  - 단어는 하이픈(-)으로 구분"
    echo "  - 예시: docs/add-react-hooks"
    echo ""
    echo "올바른 브랜치 이름 예시:"
    echo "  - docs/add-javascript-basics"
    echo "  - feat/implement-search-feature"
    echo "  - fix/correct-layout-bug"
    echo ""
    echo "커밋을 취소합니다."
    echo "========================================${NC}"
    exit 1
fi

# ========================================
# 3. 커밋 메시지 prefix 검증
# ========================================
# 브랜치 prefix 추출
BRANCH_PREFIX=$(echo "$CURRENT_BRANCH" | cut -d'/' -f1)

# 커밋 메시지 첫 줄 읽기
COMMIT_MSG_FIRST_LINE=$(head -n1 "$COMMIT_MSG_FILE")

# 기대되는 커밋 메시지 prefix
EXPECTED_PREFIX="${BRANCH_PREFIX}:"

# prefix 일치 여부 검증
if ! [[ "$COMMIT_MSG_FIRST_LINE" =~ ^${BRANCH_PREFIX}:\ .+ ]]; then
    echo -e "${RED}========================================"
    echo "[커밋 메시지 규칙 오류]"
    echo "========================================"
    echo ""
    echo "현재 브랜치: $CURRENT_BRANCH"
    echo "커밋 메시지: $COMMIT_MSG_FIRST_LINE"
    echo ""
    echo "브랜치 prefix와 커밋 메시지 prefix가 일치하지 않습니다."
    echo ""
    echo "브랜치 '${BRANCH_PREFIX}/'에서는 '${EXPECTED_PREFIX}'로 시작하는 커밋 메시지를 사용해야 합니다."
    echo ""
    echo "올바른 커밋 메시지 형식:"
    echo "  ${EXPECTED_PREFIX} <메시지 내용>"
    echo ""
    echo "예시:"
    echo "  ${EXPECTED_PREFIX} Add React Hooks documentation"
    echo ""
    echo "Prefix 매칭 규칙:"
    echo "  - docs/   → docs:"
    echo "  - edit/   → edit:"
    echo "  - delete/ → delete:"
    echo "  - feat/   → feat:"
    echo "  - fix/    → fix:"
    echo "  - remove/ → remove:"
    echo ""
    echo "커밋을 취소합니다."
    echo "========================================${NC}"
    exit 1
fi

# ========================================
# 4. 검증 성공
# ========================================
echo -e "${GREEN}✓ 브랜치 네이밍 규칙 검증 통과${NC}"
echo -e "${GREEN}✓ 커밋 메시지 규칙 검증 통과${NC}"

exit 0
