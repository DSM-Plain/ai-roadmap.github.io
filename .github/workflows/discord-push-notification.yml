################################################################################
# Discord ì›¹í›… í†µí•© ì„¤ì • ê°€ì´ë“œ
################################################################################
#
# 1. Discord ì›¹í›… ìƒì„±
#    - Discord ì±„ë„ ì„¤ì • (í†±ë‹ˆë°”í€´ ì•„ì´ì½˜) â†’ ì—°ë™ â†’ ì›¹í›…
#    - "ìƒˆ ì›¹í›…" ë²„íŠ¼ í´ë¦­
#    - ì›¹í›… ì´ë¦„ ì„¤ì • (ì˜ˆ: "GitHub Bot")
#    - "ì›¹í›… URL ë³µì‚¬" ë²„íŠ¼ í´ë¦­
#
# 2. GitHub Secrets ì„¤ì •
#    - GitHub ì €ì¥ì†Œ â†’ Settings â†’ Secrets and variables â†’ Actions
#    - "New repository secret" í´ë¦­
#    - Name: DISCORD_WEBHOOK_URL
#    - Value: (ë³µì‚¬í•œ Discord ì›¹í›… URL ë¶™ì—¬ë„£ê¸°)
#    - "Add secret" í´ë¦­
#
# 3. í…ŒìŠ¤íŠ¸
#    - main ë¸Œëœì¹˜ì— ì»¤ë°‹ push
#    - Discord ì±„ë„ì—ì„œ ì•Œë¦¼ í™•ì¸
#
# 4. ë¬¸ì œ í•´ê²°
#    - Actions íƒ­ì—ì„œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸ í™•ì¸
#    - Discord ì±„ë„ì—ì„œ ì›¹í›…ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
#    - Secret ì´ë¦„ì´ ì •í™•íˆ DISCORD_WEBHOOK_URLì¸ì§€ í™•ì¸
#
################################################################################

name: Discord Push Notification

on:
  push:
    branches: ["main"]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ ìµœì†Œ 2ê°œì˜ ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸°

      - name: Get changed files
        id: changed-files
        run: |
          # git diffë¡œ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶”ì¶œ (ìµœëŒ€ 10ê°œ)
          CHANGED_FILES=$(git diff --name-status HEAD~1 HEAD | head -10)

          # ì¶œë ¥ ë³€ìˆ˜ì— ì €ì¥ (multiline ì§€ì›)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        continue-on-error: true  # Discord ì•Œë¦¼ ì‹¤íŒ¨ê°€ ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì¤‘ë‹¨ì‹œí‚¤ì§€ ì•Šë„ë¡
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # GitHub ì»¨í…ìŠ¤íŠ¸ ë³€ìˆ˜ ì¶”ì¶œ
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT_SHA="${COMMIT_SHA:0:7}"
          AUTHOR_NAME="${{ github.event.head_commit.author.name }}"
          AUTHOR_USERNAME="${{ github.event.head_commit.author.username }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          REPO_NAME="${{ github.repository }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          CHANGED_FILES=$(cat <<'EOF'
          ${{ steps.changed-files.outputs.files }}
          EOF
          )

          # íŒŒì¼ ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€
          if [ -z "$CHANGED_FILES" ]; then
            CHANGED_FILES="ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ"
          fi

          # JSON ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ (ë”°ì˜´í‘œ, ë°±ìŠ¬ë˜ì‹œ, ì¤„ë°”ê¿ˆ)
          COMMIT_MESSAGE_ESCAPED=$(echo "$COMMIT_MESSAGE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | awk '{printf "%s\\n", $0}' | sed 's/\\n$//')
          CHANGED_FILES_ESCAPED=$(echo "$CHANGED_FILES" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')

          # Discord Embed JSON ìƒì„± ë° ì „ì†¡
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"username\": \"GitHub Bot\",
                 \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
                 \"embeds\": [{
                   \"title\": \"âœ… Main ë¸Œëœì¹˜ì— ìƒˆë¡œìš´ ì»¤ë°‹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤\",
                   \"description\": \"**ì»¤ë°‹ ë©”ì‹œì§€:** ${COMMIT_MESSAGE_ESCAPED}\\n\\n**ì‘ì„±ì:** [${AUTHOR_NAME}](https://github.com/${AUTHOR_USERNAME})\\n**ë¸Œëœì¹˜:** \\\`main\\\`\\n**ì»¤ë°‹ SHA:** \\\`${COMMIT_SHORT_SHA}\\\`\",
                   \"color\": 3447003,
                   \"fields\": [{
                     \"name\": \"ğŸ“‚ ë³€ê²½ëœ íŒŒì¼ (ìµœëŒ€ 10ê°œ)\",
                     \"value\": \"\\\`\\\`\\\`\\n${CHANGED_FILES_ESCAPED}\\n\\\`\\\`\\\`\",
                     \"inline\": false
                   }],
                   \"url\": \"${COMMIT_URL}\",
                   \"timestamp\": \"${TIMESTAMP}\",
                   \"footer\": {
                     \"text\": \"${REPO_NAME}\",
                     \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                   }
                 }]
               }" \
               "$DISCORD_WEBHOOK_URL"
