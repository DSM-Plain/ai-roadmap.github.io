name: Discord PR Notification

on:
  pull_request:
    types: [opened]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR statistics
        id: pr-stats
        run: |
          # GitHub APIë¥¼ í†µí•´ PR ë³€ê²½ í†µê³„ ê°€ì ¸ì˜¤ê¸°
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          # API í˜¸ì¶œ (GitHub í† í° ì‚¬ìš©)
          STATS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                       "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}")

          ADDITIONS=$(echo "$STATS" | jq -r '.additions')
          DELETIONS=$(echo "$STATS" | jq -r '.deletions')
          CHANGED_FILES=$(echo "$STATS" | jq -r '.changed_files')

          # ì¶œë ¥ ë³€ìˆ˜ì— ì €ì¥
          echo "additions=${ADDITIONS}" >> $GITHUB_OUTPUT
          echo "deletions=${DELETIONS}" >> $GITHUB_OUTPUT
          echo "changed_files=${CHANGED_FILES}" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        continue-on-error: true  # Discord ì•Œë¦¼ ì‹¤íŒ¨ê°€ ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì¤‘ë‹¨ì‹œí‚¤ì§€ ì•Šë„ë¡
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # GitHub ì»¨í…ìŠ¤íŠ¸ ë³€ìˆ˜ ì¶”ì¶œ
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          AUTHOR_NAME="${{ github.event.pull_request.user.login }}"
          AUTHOR_URL="${{ github.event.pull_request.user.html_url }}"
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          REPO_NAME="${{ github.repository }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # PR í†µê³„
          ADDITIONS="${{ steps.pr-stats.outputs.additions }}"
          DELETIONS="${{ steps.pr-stats.outputs.deletions }}"
          CHANGED_FILES="${{ steps.pr-stats.outputs.changed_files }}"

          # JSON ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ (ë”°ì˜´í‘œ, ë°±ìŠ¬ë˜ì‹œ)
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')

          # Discord Embed JSON ìƒì„± ë° ì „ì†¡
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"username\": \"GitHub Bot\",
                 \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
                 \"embeds\": [{
                   \"title\": \"ğŸ”” ìƒˆë¡œìš´ Pull Requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ #${PR_NUMBER}\",
                   \"description\": \"**PR ì œëª©:** ${PR_TITLE_ESCAPED}\\n\\n**ì‘ì„±ì:** [${AUTHOR_NAME}](${AUTHOR_URL})\\n**ì†ŒìŠ¤ ë¸Œëœì¹˜:** \\\`${SOURCE_BRANCH}\\\` â†’ **íƒ€ê²Ÿ ë¸Œëœì¹˜:** \\\`${TARGET_BRANCH}\\\`\",
                   \"color\": 3066993,
                   \"fields\": [
                     {
                       \"name\": \"ğŸ“Š ë³€ê²½ ìš”ì•½\",
                       \"value\": \"\\\`\\\`\\\`diff\\n+ ${CHANGED_FILES} íŒŒì¼ ë³€ê²½\\n+ ${ADDITIONS} ì¤„ ì¶”ê°€, ${DELETIONS} ì¤„ ì‚­ì œ\\n\\\`\\\`\\\`\",
                       \"inline\": false
                     },
                     {
                       \"name\": \"ğŸ”— PR í™•ì¸í•˜ê¸°\",
                       \"value\": \"[Pull Request ë³´ê¸°](${PR_URL})\\n[GitHubì—ì„œ ë¦¬ë·° ë° Approve í•˜ê¸°](${PR_URL}/files)\",
                       \"inline\": false
                     }
                   ],
                   \"url\": \"${PR_URL}\",
                   \"timestamp\": \"${TIMESTAMP}\",
                   \"footer\": {
                     \"text\": \"${REPO_NAME}\",
                     \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                   }
                 }]
               }" \
               "$DISCORD_WEBHOOK_URL"
