name: Discord PR Notification

on:
  pull_request:
    types: [opened]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR statistics
        id: pr-stats
        run: |
          # GitHub APIë¥¼ í†µí•´ PR ë³€ê²½ í†µê³„ ê°€ì ¸ì˜¤ê¸°
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          # API í˜¸ì¶œ (GitHub í† í° ì‚¬ìš©)
          STATS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                       "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}")

          ADDITIONS=$(echo "$STATS" | jq -r '.additions')
          DELETIONS=$(echo "$STATS" | jq -r '.deletions')
          CHANGED_FILES=$(echo "$STATS" | jq -r '.changed_files')

          # ì¶œë ¥ ë³€ìˆ˜ì— ì €ì¥
          echo "additions=${ADDITIONS}" >> $GITHUB_OUTPUT
          echo "deletions=${DELETIONS}" >> $GITHUB_OUTPUT
          echo "changed_files=${CHANGED_FILES}" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # GitHub ì»¨í…ìŠ¤íŠ¸ ë³€ìˆ˜ ì¶”ì¶œ
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          AUTHOR_NAME="${{ github.event.pull_request.user.login }}"
          AUTHOR_URL="${{ github.event.pull_request.user.html_url }}"
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          REPO_NAME="${{ github.repository }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # PR í†µê³„
          ADDITIONS="${{ steps.pr-stats.outputs.additions }}"
          DELETIONS="${{ steps.pr-stats.outputs.deletions }}"
          CHANGED_FILES="${{ steps.pr-stats.outputs.changed_files }}"

          # JSON í˜ì´ë¡œë“œë¥¼ jqë¡œ ì•ˆì „í•˜ê²Œ ìƒì„±
          jq -n \
            --arg title "ğŸ”” ìƒˆë¡œìš´ Pull Requestê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ #${PR_NUMBER}" \
            --arg pr_title "$PR_TITLE" \
            --arg author "$AUTHOR_NAME" \
            --arg author_url "$AUTHOR_URL" \
            --arg source "$SOURCE_BRANCH" \
            --arg target "$TARGET_BRANCH" \
            --arg pr_url "$PR_URL" \
            --arg changes "+ ${CHANGED_FILES} íŒŒì¼ ë³€ê²½\n+ ${ADDITIONS} ì¤„ ì¶”ê°€, ${DELETIONS} ì¤„ ì‚­ì œ" \
            --arg repo "$REPO_NAME" \
            --arg timestamp "$TIMESTAMP" \
            '{
              username: "GitHub Bot",
              avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              embeds: [{
                title: $title,
                description: ("**PR ì œëª©:** " + $pr_title + "\n\n**ì‘ì„±ì:** [" + $author + "](" + $author_url + ")\n**ì†ŒìŠ¤ ë¸Œëœì¹˜:** `" + $source + "` â†’ **íƒ€ê²Ÿ ë¸Œëœì¹˜:** `" + $target + "`"),
                color: 3066993,
                fields: [
                  {
                    name: "ğŸ“Š ë³€ê²½ ìš”ì•½",
                    value: ("```diff\n" + $changes + "\n```"),
                    inline: false
                  },
                  {
                    name: "ğŸ”— PR í™•ì¸í•˜ê¸°",
                    value: ("[Pull Request ë³´ê¸°](" + $pr_url + ")\n[GitHubì—ì„œ ë¦¬ë·° ë° Approve í•˜ê¸°](" + $pr_url + "/files)"),
                    inline: false
                  }
                ],
                url: $pr_url,
                timestamp: $timestamp,
                footer: {
                  text: $repo,
                  icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                }
              }]
            }' | curl -H "Content-Type: application/json" \
                      -X POST \
                      -d @- \
                      "$DISCORD_WEBHOOK_URL"
